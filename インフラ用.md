# 私募REIT情報サイト - 外部仕様書

## 1. 基本情報

### 1.1 プロダクト名

| 項目 | 内容 |
|------|------|
| **正式名称** | JAPAN-PRIVATE-REIT.COM |
| **通称** | 私募REIT情報サイト |
| **URL** | https://japan-private-reit.com |

---

### 1.2 サービス概要

**私募REIT（不動産投資信託）の情報を提供する会員制Webサイト**

適格機関投資家向けに、70以上の私募REITの詳細情報、財務資料、インタビュー記事などを提供している。

#### 主な機能

| 機能カテゴリ | 内容 |
|-------------|------|
| **REIT情報閲覧** | 70以上の私募REITの詳細情報ページ |
| **財務資料ダウンロード** | 各REITの財務PDF資料 |
| **インタビュー記事** | 運用会社へのインタビュー（5シリーズ、20記事以上） |
| **投資主情報** | 私募REIT全社の横断的な投資主一覧 |
| **関係法人情報** | 各REITの関係法人一覧 |
| **会員管理** | 新規登録、承認、一斉メール送信（管理者機能） |

---

### 1.3 利用者情報

#### 一般会員（顧客）

**対象者**: 適格機関投資家

| 属性 | 説明 |
|------|------|
| 機関投資家 | 年金基金、保険会社など |
| 金融機関 | 銀行、証券会社など |
| 資産運用会社 | 投資顧問会社など |
| 事業会社 | 一般企業 |
| その他 | 上記以外 |

**できること**:
- 私募REITの詳細情報を見る
- 財務資料（PDF）をダウンロードする
- インタビュー記事を読む
- 投資主一覧・関係法人一覧を見る

#### 管理者（社内）

**対象者**: Japan REIT株式会社のスタッフ

**できること**:
- 会員登録の承認・却下
- 会員情報の編集・削除
- 一斉メールの送信
- アクセスログの閲覧

---

### 1.4 現状の課題

#### 解決済みの問題

| 日付 | 問題 | 原因 | 対応状況 |
|------|------|------|----------|
| 2025-11-26 | 会員登録ができない | CSRFトークンエラー（GASからのリクエストが拒否） | ✅ 修正済み |

#### 潜在的な課題

| 項目 | 内容 | リスク |
|------|------|--------|
| **フレームワーク老朽化** | Rails 4.1.4（2014年リリース）を使用 | セキュリティアップデート終了 |
| **Ruby老朽化** | Ruby 2.3.8を使用 | 2019年にEOL |
| **認証ライブラリ** | bcrypt-ruby 3.0.0（古いバージョン） | 脆弱性の可能性 |
| **データベース** | MySQL 5.7 | 2023年10月にEOL |

---

### 1.5 稼働環境

#### インフラ環境

| 項目 | 内容 |
|------|------|
| **クラウド** | AWS |
| **サーバー** | EC2 (Amazon Linux) |
| **リージョン** | ap-northeast-1（東京） |
| **ホスト** | ec2-52-198-187-10.ap-northeast-1.compute.amazonaws.com |

#### 構成図

```
┌─────────────────────────────────────────────────────────────────────┐
│                           インターネット                             │
└───────────────────────────────┬─────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│  AWS - ap-northeast-1 (東京リージョン)                               │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  EC2 インスタンス                                            │   │
│  │  ┌─────────────────┐  ┌─────────────────┐                  │   │
│  │  │  Rails 4.1.4    │  │  MySQL 5.7      │                  │   │
│  │  │  Ruby 2.3.8     │  │  (ローカル?)    │                  │   │
│  │  │  ポート: 80/443 │  │  ポート: 3306   │                  │   │
│  │  └─────────────────┘  └─────────────────┘                  │   │
│  │  アプリパス: /var/www/JapanPrivateReit/                      │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

#### 関連しているサービス

| サービス | 用途 | 連携方法 |
|----------|------|----------|
| **Google Forms** | 会員登録フォームのデータ収集 | フォーム送信 → スプレッドシート保存 |
| **Google Apps Script (GAS)** | reCAPTCHA検証、Rails API連携 | HTTP POST |
| **Google reCAPTCHA v2** | ボット対策 | フロントエンド + GAS検証 |
| **Slack** | 新規登録通知 | GASからWebhook |
| **外部フォームサーバー** | 会員登録フォームホスティング | form.japan-private-reit.com |

#### 技術スタック

| カテゴリ | 技術 | バージョン |
|----------|------|-----------|
| **フレームワーク** | Ruby on Rails | 4.1.4 |
| **プログラミング言語** | Ruby | 2.3.8 |
| **データベース** | MySQL | 5.7 |
| **認証** | bcrypt-ruby | 3.0.0 |
| **モバイル対応** | jpmobile | - |
| **フロントエンド** | jQuery, CoffeeScript, SCSS | - |
| **JavaScript圧縮** | Uglifier | - |
| **画像表示** | Lightbox | - |

#### 主要Gem一覧

```ruby
# Gemfile より
gem 'rails', '4.1.4'
gem 'mysql2'                          # MySQL接続
gem 'bcrypt-ruby', '~> 3.0.0'         # パスワードハッシュ化
gem 'rails-i18n'                      # 国際化
gem 'jpmobile'                        # モバイル対応
gem 'jquery-rails'                    # jQuery
gem 'coffee-rails', '~> 4.0.0'        # CoffeeScript
gem 'sass-rails', '~> 4.0.3'          # SCSS
gem 'uglifier', '>= 1.3.0'            # JS圧縮
gem 'jbuilder', '~> 2.0'              # JSON API
gem 'therubyracer'                    # V8 JSエンジン
```

#### その他特記事項

**運用上の注意点**:
- デプロイは手動（Capistranoは未使用）
- 本番環境のDBパスワードは環境変数 `JAPANPRIVATEREIT_DATABASE_PASSWORD` で管理
- ログファイル: `/var/www/JapanPrivateReit/log/production.log`

**顧客先でのアクセス制限**:
- 会員制サイト（承認制）
- 適格機関投資家のみ登録可能
- 管理者による手動承認が必要

---

### 1.6 責任者・連絡体制

| 役割 | 担当者 | 備考 |
|------|--------|------|
| **サービス責任者** | 要確認 | Japan REIT株式会社 |
| **予算管理者** | 要確認 | - |
| **技術責任者** | 要確認 | - |
| **保守・サポート** | 要確認 | 外部委託の有無 |

---

## 2. 機能詳細

### 2.1 顧客向け機能

| 機能 | 説明 | URL |
|------|------|-----|
| トップページ | サイトのランディングページ | `/` |
| REIT詳細ページ | 各REITの詳細情報（70以上） | `/home/reit/xxx` |
| 財務資料ダウンロード | PDFファイルのダウンロード | `/home/:id/financedownload` |
| インタビュー記事 | 運用会社へのインタビュー（20記事以上） | `/interview/xxx` |
| 投資主一覧 | 全社横断の投資主リスト | `/home/unitholders` |
| 関係法人一覧 | 各REITの関係法人 | `/home/accounting` |
| 更新情報 | サイトの更新履歴 | `/home/updatelist` |
| FAQ | よくある質問 | `/home/faq` |

### 2.2 会員機能

| 機能 | 説明 | URL |
|------|------|-----|
| 会員登録 | 新規登録（外部フォーム経由） | 外部: `form.japan-private-reit.com` |
| ログイン | メール + パスワードで認証 | `/session` |
| ログアウト | セッション終了 | `/session` (DELETE) |
| パスワード再設定 | メールでリセットリンク送信 | `/members/reminder` |
| 退会 | 会員の退会処理 | `/members/:id/resign` |

### 2.3 管理者機能

| 機能 | 説明 | URL |
|------|------|-----|
| 会員一覧 | 登録済み会員の一覧表示・検索 | `/members/managelist` |
| 会員承認 | 新規登録の承認 + メール送信 | `/members/:id/managemail` |
| 会員却下 | 新規登録の却下 + メール送信 | `/members/:id/managemail` |
| 会員編集 | 会員情報の編集 | `/members/:id/manageedit` |
| 会員削除 | 会員の削除 | `/members/:id/managedelete` |
| 一斉メール | 全会員へメール送信 | `/members/managemailall` |
| ログ閲覧 | アクセスログの確認 | `/log/loglist` |

---

## 3. 会員登録フロー

```
┌─────────────────────────────────────────────────────────────────┐
│  1. ユーザーが外部フォームにアクセス                              │
│     URL: https://form.japan-private-reit.com/                   │
└───────────────────────────┬─────────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. フォーム入力 + reCAPTCHA v2 チェック                         │
│     - 名前、会社名、部署名                                        │
│     - メールアドレス、電話番号                                    │
│     - 属性（機関投資家/金融機関/...）                             │
│     - 私募REITへの参加状況                                        │
│     - 興味のある私募リート（複数選択）                            │
│     - 利用規約への同意                                            │
└───────────────────────────┬─────────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. Google Forms に送信                                          │
│     → スプレッドシートに保存                                      │
└───────────────────────────┬─────────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. Google Apps Script (GAS) が自動実行                          │
│     ① reCAPTCHA トークンをサーバー側で検証                       │
│     ② 検証成功 → Rails API に POST                               │
│     ③ Slack に通知                                               │
└───────────────────────────┬─────────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│  5. Rails で会員データを保存                                     │
│     - members テーブルに登録                                      │
│     - member_status_on = 0 (未承認)                              │
└───────────────────────────┬─────────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│  6. 管理者が会員一覧で確認                                        │
│     URL: /members/managelist                                     │
└───────────────────────────┬─────────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│  7. 承認 or 却下                                                 │
│     → 承認メール or 却下メールを送信                              │
│     → member_status_on を更新                                    │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. データベース構成

### 4.1 主要テーブル

| テーブル | 説明 |
|----------|------|
| `members` | 会員情報（名前、会社、メール、パスワード等） |
| `brands` | 私募REIT情報（70以上のブランド） |
| `member_interesting_reits` | 会員 ↔ REIT の中間テーブル（興味のあるREIT） |
| `interesting_contents` | 期待するコンテンツのマスタ（4種類） |
| `member_interesting_contents` | 会員 ↔ コンテンツ の中間テーブル |
| `logs` | アクセスログ |
| `inquiries` | お問い合わせ（現在無効） |

### 4.2 会員ステータス

| フィールド | 値 | 意味 |
|-----------|-----|------|
| `member_status_on` | 0 | 未承認 |
| `member_status_on` | 1 | 承認済み |
| `member_status_off` | 1 | 却下 |
| `admin` | 1 | 管理者 |

---

## 5. 本番環境情報

| 項目 | 値 |
|------|-----|
| URL | https://japan-private-reit.com |
| サーバー | AWS EC2 |
| ホスト | ec2-52-198-187-10.ap-northeast-1.compute.amazonaws.com |
| SSH ユーザー | ec2-user |
| SSH ポート | 22 |
| アプリケーションパス | /var/www/JapanPrivateReit/ |
| ログファイル | /var/www/JapanPrivateReit/log/production.log |
| DB名 | JapanPrivateReit_production |

---

## 6. 対応履歴

### 2025-11-26: CSRF検証エラー修正

**問題**: GASからの会員登録リクエストがCSRFトークンエラーで失敗

**原因**: GASからのPOSTリクエストにCSRFトークンが含まれていなかった

**対応**: `MembersController` に以下を追加
```ruby
skip_before_filter :verify_authenticity_token, :only => ['create']
```

**影響**: 2025年10月以降、12件以上の正規登録が失敗していた

---

## 7. 関連ドキュメント

- [会員登録データフロー](../.serena/memory/app-member-registration-data-flow-brands-interesting-contents-checkbox-post-data-many-to-many-relations.md)
- [GAS連携詳細](../.serena/memory/app-google-apps-script-automation-recaptcha-validation-rails-api-integration-slack-notification.md)
- [reCAPTCHA実装](../.serena/memory/form-recaptcha-google-forms-integration-external-registration-form-migration.md)
- [CSRF修正履歴](../.serena/memory/app-csrf-skip-fix-for-gas-registration-2025-11-26.md)
- [Docker環境構築](../.serena/memory/app-docker-mysql-environment-setup-guide-ruby2.3.8-rails4.1.4-mysql57-ubuntu1604-docker-compose.md)
